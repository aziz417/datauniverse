"use strict";$(function(){window.Datasets={dataset_upload:{files:[],autoIncrement:1,deleteFile:function(e){var t=this;this.files.forEach(function(a){a.id===e&&t.files.splice(t.files.indexOf(a),1)})},tables:[]},init:function(){this.radio=$("div.radio label > input[type=radio]"),this.complete_btn=$("button#btn-complete"),this.rating={0:5,1:4,2:3,3:2,4:1},this.txtsearch=$("input[name=txtsearch]"),this.bindEvents(),$(function(){$('[data-toggle="popover"]').popover(),$('[data-toggle="tooltip"]').tooltip()}),this.initSubscription(),this.initFree(),this.initSubcategories(),this.initFileUploader()},initFileUploader:function(){var e=this;$(document).ready(function(){var t=$("#file-list"),a=t.find("tbody"),i=function(){e.dataset_upload.files.length>0?t.removeClass("hidden"):t.addClass("hidden")},s=function(t){for(var s=0;s<e.dataset_upload.files.length;s++)if(e.dataset_upload.files[s].file.name===t.name)return void console.log("file "+t.name+" is already selected.");var n={file:t,id:e.dataset_upload.autoIncrement++};e.dataset_upload.files.push(n);var o=void 0;a.append($("<tr/>",{"data-id":n.id}).append($("<td/>").html(t.name)).append($("<td/>").append(o=$("<button/>",{href:"#",class:"btn btn-sm btn-danger","data-id":n.id}).html('<i class="fa fa-remove"></i>')))),o.click(function(t){t.preventDefault();var s=null;e.dataset_upload.deleteFile(s=$(t.currentTarget).data("id")),a.find("tr[data-id='"+s+"']").remove(),i()}),i()};$("#page-datasets-upload").find("#uploadFile").change(function(e){console.log(e.currentTarget.files);for(var t=0,a=void 0;a=e.currentTarget.files[t];t++)s(a)})})},subscription_label_clicked:!1,initSubscription:function(){},initFree:function(){function e(){$(".form-group.field-datasets-is_free input").first().prop("checked")?($(".field-datasets-price").addClass("hidden"),$(".field-datasets-sale_price").addClass("hidden")):($(".field-datasets-price").removeClass("hidden"),$(".field-datasets-sale_price").removeClass("hidden"))}var t=this,a=!1;$("#form-group-is_free .cbx-label").click(function(){a=!0}),$("#datasets-is_free").change(function(e){var i=$(e.currentTarget).prop("checked");a||(i=!i),a=!1,console.log(i),$("#datasets-price").prop("disabled",i).val(null),i?($("#datasets-is_subscription_enabled").val(0),$("#form-group-offer_subscription .cbx-container .cbx .cbx-icon").html(""),t.subscription_label_clicked=!0,$("#form-group-offer_subscription, .field-datasets-price, .field-datasets-subscription_fee, #form-group-difference").addClass("hidden")):$("#form-group-offer_subscription, .field-datasets-price, .field-datasets-subscription_fee, #form-group-difference").removeClass("hidden")}),$(".form-group.field-datasets-is_free input").change(function(){e()}),e()},initSubcategories:function(){function e(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],t=$(".form-group.field-datasets-subcategory_id");e?t.addClass("hidden"):t.removeClass("hidden")}e(),$("#datasets-category").change(function(t){var a=$(t.currentTarget).val();console.log(a),$.ajax({url:"/categories/"+a+"/get-subcategories",type:"get",dataType:"json"}).done(function(t){$("#datasets-subcategory_id option").remove(),$("#datasets-subcategory_id").val(null),$("#datasets-subcategory_id").append('<option value="">(optional) Select sub-category...</option>'),0===t.length?e():e(!1),t.forEach(function(e){$("#datasets-subcategory_id").append($("<option/>",{value:e.id}).html(e.name))})})})},bindEvents:function(){$("button#step1-fin").on("click",$.proxy(this.finishStep1,this)),$("button#back2step1").on("click",$.proxy(this.showStep1,this)),$("button#step2-fin").on("click",$.proxy(this.finishStep2,this)),$("button#back2step2").on("click",$.proxy(this.showStep1,this)),$("button#step3-fin").on("click",$.proxy(this.showStep4,this)),$("button#back2step3").on("click",$.proxy(this.showStep3,this)),$("button.write-review").on("click",$.proxy(this.writeReview)),$(".update-review").on("click",$.proxy(this.updateReview)),$("button#submitReview").on("click",$.proxy(this.submitReview)),$("a#submit-admin-approval").on("click",$.proxy(this.submitForAdminApproval)),this.radio.on("change",$.proxy(this.selectPayment)),this.complete_btn.on("click",$.proxy(this.completeUpload,this)),this.txtsearch.on("keypress",$.proxy(this.searchDs,this))},searchDs:function(e){if(13==e.which){$url=encodeURIComponent(this.txtsearch.val());var t=location.href.toString().split("?"),a=t[0];window.location.href=this.txtsearch.val()?a+"?q="+$url:a}},showStep1:function(e){e.preventDefault(),$("button#step1-fin").prop("disabled",!1),$("#tabMain a[href='#step1']").tab("show"),this.scrollToTop()},showStep2:function(e){e.preventDefault(),$("#tabMain a[href='#step2']").tab("show"),this.scrollToTop()},finishStep1:function(e){e.preventDefault();var t=null;if(this.dataset_upload.files.length>0){var a=function(e){e=Math.round(e);var t=$("#progress-upload");t.parent().removeClass("hidden"),t.attr("aria-value-now",e),t.css("width",e+"%"),t.text(e+"%")};t=$("#step1form").serializeJSON(),t.Datasets.hasHeader=$("input[name=hasHeader]").prop("checked"),$(".loader1-container").append(Site.loader("","float:right;width:120px;margin:0 auto"));var i=new FormData;this.dataset_upload.files.forEach(function(e){i.append("Datasets[file][]",e.file)}),$("#uploadImage").val()&&i.append($("#uploadImage").attr("name"),$("#uploadImage")[0].files[0]),"1"==t.Datasets.is_free&&delete t.Datasets.price,t.Datasets.description=tinymce.activeEditor.getContent();for(var s in t)i.append(s,JSON.stringify(t[s]));var n=this;$.ajax({url:"upload",type:"POST",data:i,dataType:"json",cache:!1,contentType:!1,processData:!1,xhr:function(){var e=new window.XMLHttpRequest;return e.upload.addEventListener("progress",function(e){if(e.lengthComputable){var t=e.loaded/e.total;console.log(t),a(100*t)}},!1),e.addEventListener("progress",function(e){if(e.lengthComputable){var t=e.loaded/e.total;console.log(t)}},!1),e},complete:function(e){console.log("complete");var t;try{t=JSON.parse(e.responseText)}catch(a){t=e.responseText}n.validation(t)}})}else $("div.field-datasets-file").addClass("has-error").find("div.help-block").text("File field is required.")},initDatasetTables:function(e){var t=$("#tabs-tables"),a=$("#tabs-tables-complete"),i=0;1===e.tables.length?(t.find(".nav-tabs").addClass("hidden"),a.find(".nav-tabs").addClass("hidden")):(t.find(".nav-tabs").removeClass("hidden"),a.find(".nav-tabs").removeClass("hidden")),e.tables.forEach(function(e){t.find(".nav-tabs").append($("<li/>",{role:"presentation",class:0===i?"active":null}).append($("<a/>",{href:"#table-"+i,"aria-controls":"table-"+i,role:"tab","data-toggle":"tab"}).append($("<input/>",{class:"form-control",value:e.name,type:"text",name:"name-"+i})))),a.find(".nav-tabs").append($("<li/>",{role:"presentation",class:0===i?"active":null}).append($("<a/>",{href:"#table-complete-"+i,"aria-controls":"table-complete-"+i,role:"tab","data-toggle":"tab",class:"name-"+i}).text("Table "+(i+1)))),t.find(".tab-content").append($("<div/>",{role:"tabpanel",class:"tab-pane "+(0===i?"active":""),id:"table-"+i}).html(e.csvdata)),a.find(".tab-content").append($("<div/>",{role:"tabpanel",class:"tab-pane "+(0===i?"active":""),id:"table-complete-"+i}).html(e.csvdata)),i++})},validation:function(e){e.success?($('#step1form input[name="upload_token"]').val(e.upload_token),core.headers=e.headers,$("#tabMain").find("a[href='#step3']").tab("show"),this.dataset_upload.tables=e.tables,this.initDatasetTables(e),this.normalize(),setTimeout(function(){Datasets.scrollToTop()},700)):(Datasets.parseErrors(e.messages),void 0===e.messages["datasets-file"]&&($("div.field-datasets-file").find("div.help-block").text(""),$("div.field-datasets-file").removeClass("has-error").addClass("has-success")),void 0===e.messages["datasets-subscription_fee"]&&($("div.field-datasets-subscription_fee").find("div.help-block").text(""),$("div.field-datasets-subscription_fee").removeClass("has-error").addClass("has-success"))),$(".loader-background").remove(),$("button#step1-fin").prop("disabled",!1).show()},finishStep2:function(e){e.preventDefault();core.headers;$("#tabMain a[href='#step3']").tab("show"),this.scrollToTop(),this.normalize()},normalize:function(e){$("#step3 div.tbl-container thead").removeClass("hidden"),$("#step3 div.tbl-container thead .dataset-header-text").addClass("hidden"),$("#step3 div.tbl-container thead .dataset-header").removeClass("hidden"),$("#step3 div.tbl-container thead label.chk-include").removeClass("hidden")},showStep3:function(e){e.preventDefault(),$("#tabMain a[href='#step3']").tab("show"),this.scrollToTop()},showStep4:function(e){e.preventDefault();var t=0;this.dataset_upload.tables.forEach(function(e){var a=void 0,i=void 0,s={};s.hasHeader=$("input[name=hasHeader]").prop("checked"),s.newHeaders=$("#step3").find(".table-"+t+"-normalize-form").serializeJSON(),s.oldHeaders=e.headers;var n=$("#step4").find(".tbl-container .table-"+t+"-normalize-form table"),o=$("#step3").find(".tbl-container .table-"+t+"-normalize-form table"),d=$("#step3").find(".nav-tabs input[name='name-"+t+"']").val();if($("#step4").find(".nav-tabs .name-"+t).text(d),s.hasHeader)for(i=0;i<s.oldHeaders.length;i++)n.find("thead tr th:nth-child("+(i+1)+")").find(".dataset-header-text").text(o.find("thead tr th:nth-child("+(i+1)+")").find('input[type="text"]').val()),a=n.find("tr td:nth-child("+(i+1)+"), tr th:nth-child("+(i+1)+")"),s.newHeaders.hasOwnProperty("disabled-"+i)?a.addClass("hidden"):a.removeClass("hidden");else{var r=!1;for(i=0;i<s.oldHeaders;i++){var l=!s.newHeaders.hasOwnProperty("disabled-"+i),c=n.find("thead tr th:nth-child("+(i+1)+")");c.html(""),c.text(s.newHeaders[i]),""!==s.newHeaders[i].trim()&&l&&(r=!0),a=n.find("tr td:nth-child("+(i+1)+"), tr th:nth-child("+(i+1)+")"),l?a.removeClass("hidden"):a.addClass("hidden")}r?n.find("thead").removeClass("hidden"):n.find("thead").addClass("hidden")}t++}),$("#tabMain a[href='#step4']").tab("show"),this.scrollToTop();var a=$("#step1form").serializeJSON();a.Datasets.description=tinymce.activeEditor.getContent();var i=a.Datasets;console.log(i),i.subscription_fee||(i.subscription_fee=null),$("#form-group-details-price, #form-group-details-subscription_fee").removeClass("hidden"),$("#form-group-details-is_free").addClass("hidden");for(var s in i)if(i.hasOwnProperty(s)){var n=i[s];"is_free"===s?(n=n&&""!==n&&1===parseInt(n)?"Yes":"No",console.log(n),"Yes"===n&&($("#form-group-details-is_free").removeClass("hidden"),$("#form-group-details-price, #form-group-details-sale_price, #form-group-details-subscription_fee").addClass("hidden"))):isNaN(n)||null==n||""===n.trim()||(n="$"+$.number(parseFloat(n),2)),$("#details-"+s).html(n)}for(var o="",d=0;d<window.DataAndSons.categories.length;d++)if(window.DataAndSons.categories[d].cat_id==i.category){o=window.DataAndSons.categories[d].name;break}$("#details-category").html(o)},selectPayment:function(e,t){e.preventDefault(),t=this,"custom"===$(t).val()?$("input[name=custom_price]").prop("disabled",!1).focus():$("input[name=custom_price]").prop("disabled",!0).val(null)},completeUpload:function(e){var t=this;e.preventDefault();var a=$("#step1form").serializeJSON(),i=new FormData;$("#uploadImage").val()&&i.append($("#uploadImage").attr("name"),$("#uploadImage")[0].files[0]),a.Datasets.description=tinymce.activeEditor.getContent(),a.hasHeader=$("input[name=hasHeader]").prop("checked"),a.tables=[];for(var s=$("#step3"),n=0;n<this.dataset_upload.tables.length;n++)!function(e){var i=t.dataset_upload.tables[e],n={upload_token:i.upload_token,newHeaders:s.find(".table-"+e+"-normalize-form").serializeJSON(),oldHeaders:i.headers,name:s.find('.nav-tabs input[name="name-'+e+'"]').val()};s.find(".table-"+e+'-normalize-form .chk-include input[type="checkbox"]').each(function(e,t){if(!$(t).prop("checked")){var a=$(t).attr("name").replace("disabled-","");n.newHeaders["enabled-"+a]=$(t).val()}}),a.tables.push(n)}(n);for(var o in a)a.hasOwnProperty(o)&&i.append(o,JSON.stringify(a[o]));$("button#btn-complete").prop("disabled",!0).hide(),$(".loader2-container").append(Site.loader("","float:right;width:120px;margin:0 auto"));var d=this;$.ajax({url:"post_upload",type:"POST",data:i,dataType:"json",cache:!1,contentType:!1,processData:!1,complete:function(e){var t;try{t=JSON.parse(e.responseText)}catch(a){t=e.responseText}d.successUpload(t)}})},successUpload:function(e){if(e.success){bootbox.dialog({message:"Thanks for making your data set available in Data & Sons. We sincerely appreciate you choosing us for all of your data exchange needs. We are now reviewing your data set to ensure it meets our <a href='/submitting'>Approval Policy</a>. We will complete our review within 24 hours and send you an email when your data set is available on Data & Sons.",title:"<i class='fa fa-check'></i> Submission Successful",buttons:{default:{label:"OK",className:"btn-default",callback:function(){window.location.href="/datasets/preview/"+e.dataset.did}}}})}else $("button#btn-complete").prop("disabled",!1).show(),$(".loader-background").remove()},downloadCsv:function(e,t){e.preventDefault();var a={did:$(t).attr("data-row-id")};core.ajaxCall("POST","/datasets/download",a,"",this.downloadCsvSuccess)},downloadCsvSuccess:function(e){},parseErrors:function(e){$.each(e,function(e,t){$("div.field-"+e).find("div.help-block").text(""),$("div.field-"+e).removeClass("has-success").addClass("has-error"),$("div.field-"+e).find("div.help-block").text(t)})},scrollToTop:function(){$("html,body").scrollTop($("body").offset().top)},rate:function(e,a,i){t=this,$id=$(t).closest("td").attr("data-did");var s={did:$id,rating:a};core.ajaxCall("POST","/datasets/getrate",s,"json",function(e){e.success||alert("Error: failed adding ratings")})},writeReview:function(e,t){console.log("review called"),$("#reviewModal").find("#dataset-name").text($(this).data("name")),$("#reviewModal").find("input[name=did]").val($(this).data("did")),$("#reviewModal").modal("show")},updateReview:function(e,t){console.log("review called"),$("#reviewModal").find("#dataset-name").text($(this).data("name")),$("#reviewModal").find("input[name=did]").val($(this).data("did")),$("#reviewModal").find("input[name=title]").val($(this).data("reviewtitle")),$("#reviewModal").find("textarea[name=message]").val($(this).data("message")),$("#reviewModal").modal("show")},submitReview:function(e,t){var a={did:$("#reviewModal").find("input[name=did]").val(),title:$("#reviewModal").find("input[name=title]").val(),message:$("#reviewModal").find("textarea[name=message]").val()};core.ajaxCall("POST","/datasets/submitreview",a,"json",function(e){e.success?window.location.href=location.href:alert("Error: failed adding review"),$("#reviewModal").modal("hide")})},submitForAdminApproval:function(e,t){var a={did:$(this).data("did")};core.ajaxCall("POST","/datasets/submitforadminapproval",a,"json",function(e){e.success?window.location.href=location.href:alert("Error: failed submitting for admin approval, try again later!")})}},Datasets.init()});